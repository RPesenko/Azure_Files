{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "dataCollectionRuleName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the data collection rule to create."
            },
            "defaultValue": "CTI-DCR-PAC_Monitoring"
        },
        "workspaceResourceId": {
            "type": "string",
            "metadata": {
                "description": "Specifies the Azure resource ID of the Log Analytics workspace to use to store change tracking data."
            }
        }
    },
    "variables": {
        "subscriptionId": "[substring(parameters('workspaceResourceId'), 15, sub(indexOf(parameters('workspaceResourceId'), '/resourceGroups/'), 15))]",
        "resourceGroupName": "[substring(parameters('workspaceResourceId'), add(indexOf(parameters('workspaceResourceId'), '/resourceGroups/'), 16), sub(sub(indexOf(parameters('workspaceResourceId'), '/providers/'), indexOf(parameters('workspaceResourceId'), '/resourceGroups/')),16))]",
        "workspaceName": "[substring(parameters('workspaceResourceId'), add(lastIndexOf(parameters('workspaceResourceId'), '/'), 1), sub(length(parameters('workspaceResourceId')), add(lastIndexOf(parameters('workspaceResourceId'), '/'), 1)))]"
    },
    "resources": [
        {
            "type": "microsoft.resources/deployments",
            "name": "get-workspace-region",
            "apiVersion": "2020-08-01",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [],
                    "outputs": {
                        "workspaceLocation": {
                            "type": "string",
                            "value": "[reference(parameters('workspaceResourceId'), '2020-08-01', 'Full').location]"
                        }
                    }
                }
            }
        },
        {
            "type": "microsoft.resources/deployments",
            "name": "CtDcr-Deployment",
            "apiVersion": "2020-08-01",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "workspaceRegion": {
                        "value": "[reference('get-workspace-region').outputs.workspaceLocation.value]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "workspaceRegion": {
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "type": "microsoft.insights/dataCollectionRules",
                            "apiVersion": "2023-03-11",
                            "name": "[parameters('dataCollectionRuleName')]",
                            "location": "[parameters('workspaceRegion')]",
                            "properties": {
                                "description": "Data collection rule for CT.",
                                "dataSources": {
                                    "extensions": [
                                        {
                                            "streams": [
                                                "Microsoft-ConfigurationChange",
                                                "Microsoft-ConfigurationChangeV2",
                                                "Microsoft-ConfigurationData"
                                            ],
                                            "extensionName": "ChangeTracking-Windows",
                                            "extensionSettings": {
                                                "enableFiles": true,
                                                "enableSoftware": true,
                                                "enableRegistry": true,
                                                "enableServices": true,
                                                "enableInventory": true,
                                                "registrySettings": {
                                                    "registryCollectionFrequency": 3000,
                                                    "registryInfo": [
                                                        {
                                                            "name": "PAC_Signature_Validation_Level",
                                                            "groupTag": "PAC_Monitoring",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "Determine PAC Validation level by monitoring PacSignatureValidationLevel registry value",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\LSA\\Kerberos\\Parameters",
                                                            "valueName": "PacSignatureValidationLevel"
                                                        },
                                                        {
                                                            "name": "CrossDomainFilteringLevel",
                                                            "groupTag": "PAC_Monitoring",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "Determine Cross Domain Filtering level by monitoring CrossDomainFilteringLevel registry value",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\LSA\\Kerberos\\Parameters",
                                                            "valueName": "CrossDomainFilteringLevel"
                                                        },
                                                        {
                                                            "name": "Audit_Kerberos_Ticket_Logon_Events",
                                                            "groupTag": "PAC_Monitoring",
                                                            "enabled": true,
                                                            "recurse": false,
                                                            "description": "Determine Audit Kerberos Ticket Logon Events by monitoring AuditKerberosTicketLogonEvents registry value",
                                                            "keyName": "HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\Netlogon\\Parameters",
                                                            "valueName": "AuditKerberosTicketLogonEvents"
                                                        }
                                                    ]
                                                },
                                                "fileSettings": {
                                                    "fileCollectionFrequency": 2700
                                                },
                                                "softwareSettings": {
                                                    "softwareCollectionFrequency": 1800
                                                },
                                                "inventorySettings": {
                                                    "inventoryCollectionFrequency": 36000
                                                },
                                                "servicesSettings": {
                                                    "serviceCollectionFrequency": 1800
                                                }
                                            },
                                            "name": "CTDataSource-Windows"
                                        },
                                        {
                                            "streams": [
                                                "Microsoft-ConfigurationChange",
                                                "Microsoft-ConfigurationChangeV2",
                                                "Microsoft-ConfigurationData"
                                            ],
                                            "extensionName": "ChangeTracking-Linux",
                                            "extensionSettings": {
                                                "enableFiles": false,
                                                "enableSoftware": false,
                                                "enableRegistry": false,
                                                "enableServices": false,
                                                "enableInventory": false,
                                                "fileSettings": {
                                                    "fileCollectionFrequency": 900,
                                                    "fileInfo": [
                                                        {
                                                            "name": "ChangeTrackingLinuxPath_default",
                                                            "description": "",
                                                            "destinationPath": "/etc/.*.conf",
                                                            "pathType": "File",
                                                            "recurse": true,
                                                            "links": "Follow",
                                                            "uploadContent": false,
                                                            "maxOutputSize": 500000,
                                                            "groupTag": "Recommended",
                                                            "maxContentsReturnable": 5000000,
                                                            "useSudo": true,
                                                            "enabled": false
                                                        }
                                                    ]
                                                },
                                                "softwareSettings": {
                                                    "softwareCollectionFrequency": 300
                                                },
                                                "inventorySettings": {
                                                    "inventoryCollectionFrequency": 36000
                                                },
                                                "servicesSettings": {
                                                    "serviceCollectionFrequency": 300
                                                }
                                            },
                                            "name": "CTDataSource-Linux"
                                        }
                                    ]
                                },
                                "destinations": {
                                    "logAnalytics": [
                                        {
                                            "workspaceResourceId": "[parameters('workspaceResourceId')]",
                                            "name": "Microsoft-CT-Dest"
                                        }
                                    ]
                                },
                                "dataFlows": [
                                    {
                                        "streams": [
                                            "Microsoft-ConfigurationChange",
                                            "Microsoft-ConfigurationChangeV2",
                                            "Microsoft-ConfigurationData"
                                        ],
                                        "destinations": [
                                            "Microsoft-CT-Dest"
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationsManagement/solutions",
                            "name": "[Concat('ChangeTracking', '(', variables('workspaceName'), ')')]",
                            "location": "[parameters('workspaceRegion')]",
                            "apiVersion": "2015-11-01-preview",
                            "id": "[Concat('/subscriptions/', variables('subscriptionId'), '/resourceGroups/', variables('resourceGroupName'), '/providers/Microsoft.OperationsManagement/solutions/ChangeTracking', '(', variables('workspaceName'), ')')]",
                            "properties": {
                                "workspaceResourceId": "[parameters('workspaceResourceId')]"
                            },
                            "plan": {
                                "name": "[Concat('ChangeTracking', '(', variables('workspaceName'), ')')]",
                                "product": "OMSGallery/ChangeTracking",
                                "promotionCode": "",
                                "publisher": "Microsoft"
                            }
                        }
                    ]
                }
            }
        }
    ]
}